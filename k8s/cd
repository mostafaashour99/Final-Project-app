pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        spec:
          containers:
           - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - sleep
            args:
            - 99d
            tty: true
          - name: docker
            image: docker:dind
            tty: true
            securityContext:
              privileged: true
        '''
    }
  }
    stages {
	    stage('Build container') {
	      steps {
		container('docker') {
		  sh 'docker version'
		  sh "docker build . -t mostafaashour99/py-app:$BUILD_NUMBER" 
		  withDockerRegistry([ credentialsId: "dockerhub_auth", url: "" ]) {
                 	sh "docker push mostafaashour99/py-app:$BUILD_NUMBER"
                }
	      }
	    }
	}
	   stage('Deploy new image') {
	      steps {
		container('kubectl') {
		 	kubeconfig(caCertificate: '''-----BEGIN CERTIFICATE-----
MIIELDCCApSgAwIBAgIQX1bzOzjpui7Ne12WGMT2xDANBgkqhkiG9w0BAQsFADAv
MS0wKwYDVQQDEyQyZDdjNWYwYy1iNjcxLTQwZDgtYWI0NS1iYjE0NWJjY2FmNjcw
IBcNMjIxMDMxMjAzOTQ2WhgPMjA1MjEwMjMyMTM5NDZaMC8xLTArBgNVBAMTJDJk
N2M1ZjBjLWI2NzEtNDBkOC1hYjQ1LWJiMTQ1YmNjYWY2NzCCAaIwDQYJKoZIhvcN
AQEBBQADggGPADCCAYoCggGBAL9wNUUU2wV5RlmwQQHXfVMMTMxSUKyDoWNvgoWv
5WKWZbF0DQuNqppt8RxCpLY0vUgkeBntJi26q8B50PA45cxx7Q6285irC9SOSegk
uS50tBhxdJSe9mEm+pFm0OB6s8jMXd4W67sFNzhz7PSSEWl5NMOmf+edDUR6zCsy
IQfzBX39QuzPrrmCRQjPYKiomUEnYd/mZm/PSB3mGSMOE7QleDh4/KgO6pVzvPmT
9/SI9xHN1wjhpceS8wszmvxObobPcy9Rntyz2XN81eQkMSlbi0GVjNr5BgUptjbb
Ud0kgMNE4w3lrpTL3+3UePnXIzAwS6h5KtR2Uhc9OAUVTKjE63Rbvaf6DN+5bqdj
qdAuza69aBcL/sdxWtEiHLEYPYG9K0lHwgrg24F6vvYizhe+9v6rMmH1CbtCfthY
vpQu1Q2FEnwg43nK7U3QJoEBz5Qa8yLj5LKotwB6RFaQUmpHSLr0K4WcuI0y4Maz
gqLmTjQf5rjzGC7KTPXGDLEWqQIDAQABo0IwQDAOBgNVHQ8BAf8EBAMCAgQwDwYD
VR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUOBavgfeMWzCsEOASxFLE9XSblk4wDQYJ
KoZIhvcNAQELBQADggGBAIKvGCQZ1H8gcyqhsiQ9TCtq3QJ0TWc91/Dx9xlG6ulk
N7hsX8J7MmN1O6fBSmk4UCH5Kt+1Nbm1G8C/tMP/HBCXMuFbHVkHSAbDEcHdA/S/
hNYyym5F8TeefACS+aAt4I/c1SV9gvQ2CYONiMx4+borEPLwE3JbZJJCClhF0aZS
wzM6NaG/VYx8ihdxHlqDmJccp4rGdAcJzYUN5yj8zAK9BMXbrpa4N8T5Rr5w6RNP
3Iqgiryr/3aANNNF6qKpoQxA1nbnSTrpZNaR8wPc7H9gXvxJX7aSJHusXRgsI1yl
JJc8eMJwXvkPQ7UzBfETFP5dLuEaFOtZ54bce8IQMcjDSCijw1qH9+WQ/ufkDs5u
QO1H+XpyYy2fqgC2tRqjTUkYQgBR7DQsGh9QqUdzNCsp12Cp/uyYMQiFdbRLqBsE
ZYHqIODxa0GMVJ3dNRk4nvaPjIPRHYrR281PqeuvscwNPXb4w1J4ePALs8YTLk0G
j4vGPh12+SKQ2KIXAOcReA==
-----END CERTIFICATE-----''', credentialsId: 'mostafa-ashour-project', serverUrl: 'https://35.224.32.45') {
				sh 'kubectl apply -f k8s/app/python-deploy.yaml'
			}
		  }
		}
	      }
	}
}



