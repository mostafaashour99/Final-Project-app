pipeline {
  agent {
    kubernetes {
      yaml '''
        apiVersion: v1
        kind: Pod
        spec:
          containers:
           - name: kubectl
            image: bitnami/kubectl:latest
            command:
            - sleep
            args:
            - 99d
            tty: true
          - name: docker
            image: docker:dind
            tty: true
            securityContext:
              privileged: true
        '''
    }
  }
    stages {
	    stage('Build container') {
	      steps {
		container('docker') {
		  sh 'docker version'
		  sh "docker build . -t mostafaashour99/py-app:$BUILD_NUMBER" 
		  withDockerRegistry([ credentialsId: "dockerhub_auth", url: "" ]) {
                 	sh "docker push mostafaashour99/py-app:$BUILD_NUMBER"
                }
	      }
	    }
	}
	   stage('Deploy new image') {
	      steps {
		container('kubectl') {
		 	kubeconfig(credentialsId: 'mostafa-ashour-project', serverUrl: 'https://35.224.32.45') {
				sh 'kubectl apply -f k8s/app/python-deploy.yaml'
			}
		  }
		}
	      }
	}
}



